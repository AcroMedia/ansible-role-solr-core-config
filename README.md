# ansible-role-solr-core-config

![.github/workflows/molecule.yml](https://github.com/AcroMedia/ansible-role-solr-core-config/workflows/.github/workflows/molecule.yml/badge.svg)

Copy a config set from an arbitrary location (ie one that ships with the solr drupal module) into the solr core's config directory.

This is meant to be used in conjunction with (and after both of) GeerlingGuy's solr role, and Acro Media's virtual host role.

**Warning**: All of the contents of  `/{{ solr_home }}/data/{{ solr_core_name }}/conf` will be replaced by the contents of `{{ solr_core_conf_source }}`. If you want your conf dir backed up, you'll need to do that before running this role.


## Requirements

* Your solr core must already exist. If you're using [GeerlingGuy's solr role](https://github.com/geerlingguy/ansible-role-solr), then list your core name as one of the items in the `solr_cores` variable. Or create your core manually in the Solr UI. Or run the solr cli to create your core. Once your core is created, the directory specified by `solr_core_conf_dest` will exist, and this role can do its job.
* Your source core conf files must already exist, either remotely on the server, or ready to be pushed to the server by the playbook.
  * When  `solr_core_conf_local_source` is specified, files are pushed by the playbook to the server first, and then the role sets the value of `solr_core_conf_source` itself.
  * When `solr_core_conf_source` is specified, the role syncs them from wherever they are on the server, into the solr config directory for that core, sets correct ownership and permissions on them.
  * Drupal 7 solr config can be obtained from the search api module.
  * Drupal 8 solr config must be generated by Drupal (which seems awkward, because it is).


## Role Variables

### Required:
* **solr_core_name**: Name of the solr core that the conf files will be attached to
* One of  **solr_core_conf_local_source** OR **solr_core_conf_source**:
  * `solr_core_conf_local_source`: Absolute path to the directory on the ansible controller that contains your config set. If this variable is set, any previous value for `solr_core_conf_source` is ignored.
  * `solr_core_conf_source`: Absolute path to the directory on the server that contains your solr schema files. This can be used when you've committed your schema files to your drupal repository, and then your CI deploy job has already placed them on the server, ready for processing by this role.


### Optional:
* **solr_service_name**: In case your solr service is named something other than `solr`.
* **solr_home**: In case your solr files were configured somewhere other than `/var/solr`
* **solr_core_conf_dest**: Defaults to `"{{ solr_home }}/data/{{ solr_core_name }}/conf"`. You shouldn't ever need to change this. It's only noted here, because it's very easy to miss creating your core before using t his role. This role does not create the solr core for you. See the [Requirements](#Requirements) section above.


## Dependencies

- [geerlingguy.solr](https://github.com/geerlingguy/ansible-role-solr)
- [acromedia.virtual-host](https://github.com/AcroMedia/ansible-role-virtual-host/)


## Example Playbooks

```yaml
    - hosts: servers
      roles:
        - name: Configure a solr 6 core using config that shipped with the Drupal 7 module
          role: acromedia.solr-core-config
          vars:
            solr_core_conf_source: /var/www/html/siteXYZ/modules/contrib/search_api_solr/solr-conf/6.x
            solr_core_name: coreXYZ
```

```yaml
    - hosts: servers
      roles:
        - name: Configure a 2nd solr core running for a different version of solr (7), which is side by side with the first (6)
          role: acromedia.solr-core-config
          vars:
            solr_core_conf_source: /var/www/html/siteABC/modules/contrib/search_api_solr/solr-conf/7.x
            solr_core_name: coreABC
            solr_service_name: solr7
            solr_home: /var/solr7
```

```yaml
- hosts: servers
  roles:
    - name: Use locally committed solr schema (which we generated from Drupal 8), to configure a solr core
      role: acromedia.solr-core-config
      vars:
        solr_core_conf_local_source: "{{ playbook_dir }}/solr/config"
        solr_core_name: coreBFG
```

## License

GPLv3


## Author Information

Acro Media Inc.
